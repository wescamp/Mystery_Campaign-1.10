#textdomain wesnoth-Mystery_Campaign

#define RANDOM_NO_MIRROR
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=all_leaders
        [/store_unit]

        ## get all factions in game
        [set_variables]
            name=all_factions
            [value]
                {~add-ons/Mystery_Campaign/factions}
            [/value]
        [/set_variables]

        {FOREACH all_factions.multiplayer_side i}
            {IF_VAR factions equals $null (
                [then]
                    {VARIABLE factions $all_factions.multiplayer_side[$i].id}
                [/then]
                [else]
                    {VARIABLE factions ($factions + "," + $all_factions.multiplayer_side[$i].id)}
                [/else]
            )}
        {NEXT i}

        ## check if some sides already have faction choosen
        {VARIABLE sides $all_leaders.length}
        {VARIABLE index "$($all_leaders.length-1)"}
        #[inspect][/inspect]
        [while]
            [variable]
                name=sides
                greater_than=0
            [/variable]
            [do]
                [store_side]
                    side=$all_leaders[$index].side
                    variable=current_side
                [/store_side]

                [if]
                    [variable]
                        name=all_leaders[$index].type
                        not_equals="EE_dummy_unit"
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Merman Fighter" #spearman is to generic
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",Loyalists")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Elvish Fighter"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",Rebels")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Orcish Grunt"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",Northerners")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Skeleton"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",Undead")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Drake Fighter"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",Drakes")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="EE Aragwaith Swordsman"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",aragwaithi")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="EE Dark Elf Fighter"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",dark_elves")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="EE Dark Raider"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",dark_legion")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="EE Cavalryman"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",frontiers")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Thief"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",outlaws")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="EE Jundi"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",khalifate")}
                            [/then]
                        [/if]

                        [if]
                            [variable]
                                name=current_side.recruit
                                contains="Dwarvish Fighter"
                            [/variable]
                            [then]
                                {VARIABLE used_factions ($used_factions + ",dwarves")}
                            [/then]
                        [/if]
                    [/then]
                [/if]
                {VARIABLE_OP sides sub 1}
                {VARIABLE_OP index sub 1}
                {CLEAR_VARIABLE current_side}
            [/do]
        [/while]
        {CLEAR_VARIABLE index}

        ## loop througth all sides and replace the dummy units with a real leader
        {VARIABLE sides $all_leaders.length}
        [while]
            [variable]
                name=sides
                greater_than=0
            [/variable]
            [do]
                [store_unit]
                    [filter]
                        side=$sides
                    [/filter]
                    variable=leader
                [/store_unit]

                {IF_VAR leader.type equals "EE_dummy_unit" (
                    [then]
                        {VARIABLE_OP side_$sides|_faction rand($factions)}
                        [while]
                            [variable]
                                name=used_factions
                                contains=$side_$sides|_faction
                            [/variable]
                            [do]
                                {VARIABLE_OP side_$sides|_faction rand($factions)}
                            [/do]
                        [/while]
                        #[inspect][/inspect]

                        {VARIABLE index 0}
                        [while]
                            [variable]
                                name=index
                                less_than=$all_factions.multiplayer_side.length
                            [/variable]
                            [do]
                                [if]
                                    [variable]
                                        name=all_factions.multiplayer_side[$index].id
                                        equals=$side_$sides|_faction
                                    [/variable]
                                    [then]
                                        [kill]
                                            side=$sides
                                        [/kill]

                                        {IF_VAR all_factions.multiplayer_side[$index].random_leader equals $null (
                                            [then]
                                                [set_variable]
                                                    name=leader_type
                                                    rand=$all_factions.multiplayer_side[$index].leader
                                                [/set_variable]
                                            [/then]
                                            [else]
                                                [set_variable]
                                                    name=leader_type
                                                    rand=$all_factions.multiplayer_side[$index].random_leader
                                                [/set_variable]
                                            [/else]
                                        )}

                                        [unit]
                                            side=$sides
                                            id=$leader.id
                                            x,y=$leader.x,$leader.y
                                            type=$leader_type
                                            canrecruit=yes
                                            name=$leader.name
                                            random_gender=yes
                                            random_traits=no
                                        [/unit]

                                        [set_recruit]
                                            side=$sides
                                            recruit=$all_factions.multiplayer_side[$index].recruit
                                        [/set_recruit]

                                        {CLEAR_VARIABLE leader_type}
                                    [/then]
                                [/if]
                                {VARIABLE_OP index add 1}
                            [/do]
                        [/while]
                        {VARIABLE used_factions ($used_factions + "," + $side_$sides|_faction)}
                        {CLEAR_VARIABLE index,side_$sides|_faction}
                    [/then]
                )}
                {VARIABLE_OP sides sub 1}
                {CLEAR_VARIABLE leader}
            [/do]
        [/while]
        {CLEAR_VARIABLE all_factions,all_leaders,factions,sides,used_factions}
        #[inspect][/inspect]
    [/event]
#enddef

#define SLOW_QUICK_LEADERS
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=leader
        [/store_unit]

        {FOREACH leader i}
            ## all leaders quicker than 6 movement get slow
            {IF_VAR leader[$i].max_moves greater_than 6 (
                [then]
                    [set_variables]
                        name=temp
                        [literal]
                            {TRAIT_SLOW}
                        [/literal]
                    [/set_variables]
                    [set_variables]
                        name=leader[$i].modifications.trait
                        mode=append
                        [insert_tag]
                            name=literal
                            variable=temp.trait
                        [/insert_tag]
                    [/set_variables]
                    {CLEAR_VARIABLE leader[$i].max_moves,leader[$i].moves,leader[$i].max_hitpoints,leader[$i].hitpoints}
                    [unstore_unit]
                        variable=leader[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            )}
        {NEXT i}
        {CLEAR_VARIABLE leader,temp}
    [/event]
#enddef

#define NERF_LEADERSHIP_UNITS
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=leader
        [/store_unit]

        {FOREACH leader i}
            ## loop througth all abilities
            {FOREACH leader[$i].abilities j}
                ## if an leadership type give aged trait
                {IF_VAR leader[$i].abilities[$j].leadership.id not_equals $null (
                    [then]
                        [set_variables]
                            name=temp
                            [literal]
                                {TRAIT_AGED}
                            [/literal]
                        [/set_variables]
                        [set_variables]
                            name=leader[$i].modifications.trait
                            mode=append
                            [insert_tag]
                                name=literal
                                variable=temp.trait
                            [/insert_tag]
                        [/set_variables]
                        {CLEAR_VARIABLE leader[$i].max_moves,leader[$i].moves,leader[$i].max_hitpoints,leader[$i].hitpoints}
                        ## has to be set by hand
                        {FOREACH leader[$i].attack k}
                            ## if melee sub 1 damage
                            {IF_VAR leader[$i].attack[$k].range equals melee (
                                [then]
                                    {VARIABLE_OP leader[$i].attack[$k].damage sub 1}
                                [/then]
                            )}
                        {NEXT k}
                        [unstore_unit]
                            variable=leader[$i]
                            find_vacant=no
                        [/unstore_unit]
                    [/then]
                )}
            {NEXT j}
        {NEXT i}
        {CLEAR_VARIABLE leader,temp}
    [/event]
#enddef

#define NERF_HEALING_UNITS
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=leader
        [/store_unit]

        {FOREACH leader i}
            ## get this variable because units can have multiple healing/curing abilities
            {VARIABLE already_nerfed no}

            ## loop througth all abilities
            {FOREACH leader[$i].abilities j}
                ## check if dim is already given
                {FOREACH leader[$i].modifications.trait k}
                    {IF_VAR leader[$i].modifications.trait[$k].id equals dim (
                        [then]
                            {VARIABLE already_nerfed yes}
                        [/then]
                    )}
                {NEXT k}

                ## if have any healing ability and not already dim give that trait
                [if]
                    [and]
                        [variable]
                            name=leader[$i].abilities[$j].heals.id
                            not_equals=$null
                        [/variable]
                        [variable]
                            name=already_nerfed
                            not_equals=yes
                        [/variable]
                    [/and]
                    [then]
                        [set_variables]
                            name=temp
                            [literal]
                                {TRAIT_DIM}
                            [/literal]
                        [/set_variables]
                        [set_variables]
                            name=leader[$i].modifications.trait
                            mode=append
                            [insert_tag]
                                name=literal
                                variable=temp.trait
                            [/insert_tag]
                        [/set_variables]
                        {CLEAR_VARIABLE leader[$i].max_experience}
                        [unstore_unit]
                            variable=leader[$i]
                            find_vacant=no
                        [/unstore_unit]
                    [/then]
                [/if]
            {NEXT j}
        {NEXT i}
        {CLEAR_VARIABLE leader,temp,already_nerfed}
    [/event]
#enddef

#define NERF_UNITS_WITH_SPECIAL_ABILITIES
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=leader
        [/store_unit]

        {FOREACH leader i}
            ## set variable
            {VARIABLE nerf_unit no}

            ## loop througth all abilities
            {FOREACH leader[$i].abilities j}
                ## if have an illuminating/skirmishing/steadfast ability
                [if]
                    [variable]
                        name=leader[$i].abilities[$j].illuminates.id
                        not_equals=$null
                    [/variable]
                    [or]
                        [variable]
                            name=leader[$i].abilities[$j].skirmisher.id
                            not_equals=$null
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=leader[$i].abilities[$j].resistance.id
                            not_equals=$null
                        [/variable]
                    [/or]
                    [then]
                        {VARIABLE nerf_unit yes}
                    [/then]
                [/if]
            {NEXT j}

            ## loop througth all attacks
            {FOREACH leader[$i].attack k}
                ## check all specials of that attack
                {FOREACH leader[$i].attack[$k].specials l}
                    ## if charge/counter (damage), firstrike or marksman/magical (chance to hit)
                    [if]
                        [variable]
                            name=leader[$i].attack[$k].specials[$l].damage.id
                            not_equals=$null
                        [/variable]
                        [or]
                            [variable]
                                name=leader[$i].attack[$k].specials[$l].firststrike.id
                                not_equals=$null
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=leader[$i].attack[$k].specials[$l].chance_to_hit.id
                                not_equals=$null
                            [/variable]
                        [/or]
                        [then]
                            {VARIABLE nerf_unit yes}
                        [/then]
                    [/if]
                {NEXT l}
            {NEXT k}

            ## if having any special above give weak trait
            {IF_VAR nerf_unit equals yes (
                [then]
                    [set_variables]
                        name=temp
                        [literal]
                            {TRAIT_WEAK}
                        [/literal]
                    [/set_variables]
                    [set_variables]
                        name=leader[$i].modifications.trait
                        mode=append
                        [insert_tag]
                            name=literal
                            variable=temp.trait
                        [/insert_tag]
                    [/set_variables]
                    {CLEAR_VARIABLE leader[$i].max_hitpoints,leader[$i].hitpoints}
                    {FOREACH leader[$i].attack m}
                        {IF_VAR leader[$i].attack[$m].range equals melee (
                            [then]
                                {VARIABLE_OP leader[$i].attack[$m].damage sub 1}
                            [/then]
                        )}
                    {NEXT m}
                    [unstore_unit]
                        variable=leader[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            )}
        {NEXT i}
        {CLEAR_VARIABLE leader,temp,nerf_unit}
    [/event]
#enddef

#define RANDOM_LEADER_TRAITS
    [event]
        name=prestart

        [store_unit]
            [filter]
                canrecruit=yes
            [/filter]
            variable=leader
        [/store_unit]

        {FOREACH leader i}
            ## Wose should get fearless (buffing them)
            {IF_VAR leader[$i].type contains Wose (
                [then]
                    [set_variables]
                        name=temp
                        [literal]
                            {TRAIT_FEARLESS}
                        [/literal]
                    [/set_variables]
                    [set_variables]
                        name=leader[$i].modifications.trait
                        mode=append
                        [insert_tag]
                            name=literal
                            variable=temp.trait
                        [/insert_tag]
                    [/set_variables]
                    [unstore_unit]
                        variable=leader[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
                [else]
                    ## check if the unit has any ranged attack
                    {FOREACH leader[$i].attack x}
                        {IF_VAR leader[$i].attack[$x].range equals ranged (
                            [then]
                                {VARIABLE have_ranged yes}
                            [/then]
                        )}
                    {NEXT x}

                    ## if not already two traits are assigted
                    [while]
                        [variable]
                            name=leader[$i].modifications.trait.length
                            less_than=2
                        [/variable]
                        [do]
                            ## pick up one trait
                            {VARIABLE_OP random_traits rand(strong,resilient,healthy,dextrous,intelligent)}
                            ## repeat if duplicated or odd combination
                            [while]
                                ## already given
                                [variable]
                                    name=random_traits
                                    equals=$leader[$i].modifications.trait[0].id
                                [/variable]
                                [or]
                                    ## strong and weak are a no-go
                                    [and]
                                        [variable]
                                            name=random_traits
                                            equals=strong
                                        [/variable]
                                        [variable]
                                            name=leader[$i].modifications.trait[0].id
                                            equals=weak
                                        [/variable]
                                    [/and]
                                [/or]
                                [or]
                                    ## intelligent and dim to
                                    [and]
                                        [variable]
                                            name=random_traits
                                            equals=intelligent
                                        [/variable]
                                        [variable]
                                            name=leader[$i].modifications.trait[0].id
                                            equals=dim
                                        [/variable]
                                    [/and]
                                [/or]
                                [or]
                                    ## only give dextrous to ranged units
                                    [and]
                                        [variable]
                                            name=random_traits
                                            equals=dextrous
                                        [/variable]
                                        [variable]
                                            name=have_ranged
                                            not_equals=yes
                                        [/variable]
                                    [/and]
                                [/or]
                                [or]
                                    ## dont give intelligent to trolls
                                    [and]
                                        [variable]
                                            name=random_traits
                                            equals=intelligent
                                        [/variable]
                                        [variable]
                                            name=leader[$i].type
                                            contains=Troll
                                        [/variable]
                                    [/and]
                                [/or]
                                [do]
                                    {VARIABLE_OP random_traits rand(strong,resilient,healthy,dextrous,intelligent)}
                                [/do]
                            [/while]

                            ## assign the the traits
                            [switch]
                                variable=random_traits
                                [case]
                                    value=strong
                                    [set_variables]
                                        name=temp
                                        [literal]
                                            {TRAIT_STRONG}
                                        [/literal]
                                    [/set_variables]
                                    [set_variables]
                                        name=leader[$i].modifications.trait
                                        mode=append
                                        [insert_tag]
                                            name=literal
                                            variable=temp.trait
                                        [/insert_tag]
                                    [/set_variables]
                                    {CLEAR_VARIABLE leader[$i].hitpoints,leader[$i].max_hitpoints}
                                    {FOREACH leader[$i].attack j}
                                        {IF_VAR leader[$i].attack[$j].range equals melee (
                                            [then]
                                                {VARIABLE_OP leader[$i].attack[$j].damage add 1}
                                            [/then]
                                        )}
                                    {NEXT j}
                                [/case]
                                [case]
                                    value=resilient
                                    [set_variables]
                                        name=temp
                                        [literal]
                                            {TRAIT_RESILIENT}
                                        [/literal]
                                    [/set_variables]
                                    [set_variables]
                                        name=leader[$i].modifications.trait
                                        mode=append
                                        [insert_tag]
                                            name=literal
                                            variable=temp.trait
                                        [/insert_tag]
                                    [/set_variables]
                                    {CLEAR_VARIABLE leader[$i].hitpoints,leader[$i].max_hitpoints}
                                [/case]
                                [case]
                                    value=healthy
                                    [set_variables]
                                        name=temp
                                        [literal]
                                            {TRAIT_HEALTHY}
                                        [/literal]
                                    [/set_variables]
                                    [set_variables]
                                        name=leader[$i].modifications.trait
                                        mode=append
                                        [insert_tag]
                                            name=literal
                                            variable=temp.trait
                                        [/insert_tag]
                                    [/set_variables]
                                    {CLEAR_VARIABLE leader[$i].hitpoints,leader[$i].max_hitpoints}
                                [/case]
                                [case]
                                    value=dextrous
                                    [set_variables]
                                        name=temp
                                        [literal]
                                            {TRAIT_DEXTROUS}
                                        [/literal]
                                    [/set_variables]
                                    [set_variables]
                                        name=leader[$i].modifications.trait
                                        mode=append
                                        [insert_tag]
                                            name=literal
                                            variable=temp.trait
                                        [/insert_tag]
                                    [/set_variables]
                                    {FOREACH leader[$i].attack j}
                                        {IF_VAR leader[$i].attack[$j].range equals ranged (
                                            [then]
                                                {VARIABLE_OP leader[$i].attack[$j].damage add 1}
                                            [/then]
                                        )}
                                    {NEXT j}
                                [/case]
                                [case]
                                    value=intelligent
                                    [set_variables]
                                        name=temp
                                        [literal]
                                            {TRAIT_INTELLIGENT}
                                        [/literal]
                                    [/set_variables]
                                    [set_variables]
                                        name=leader[$i].modifications.trait
                                        mode=append
                                        [insert_tag]
                                            name=literal
                                            variable=temp.trait
                                        [/insert_tag]
                                    [/set_variables]
                                    {CLEAR_VARIABLE leader[$i].max_experience}
                                [/case]
                            [/switch]
                        [/do]
                    [/while]
                    [unstore_unit]
                        variable=leader[$i]
                        find_vacant=no
                    [/unstore_unit]
                    {CLEAR_VARIABLE have_ranged,random_traits}
                [/else]
            )}
        {NEXT i}
        {CLEAR_VARIABLE leader,temp}
    [/event]
#enddef
